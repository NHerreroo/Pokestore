<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PokéStore</title>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&family=Poppins:wght@300;400;500;600;700&display=swap"
          rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" th:href="@{/pokemon-style.css}">
</head>
<body>
<div class="app-container">
    <div class="sidebar">
        <div class="logo-container">
            <div class="pokeball">
                <div class="pokeball-top"></div>
                <div class="pokeball-middle"></div>
                <div class="pokeball-bottom"></div>
            </div>
            <h2>Pokémon TCG</h2>
        </div>
        <nav class="sidebar-nav">
            <ul>
                <li class="active"><a href="#"><i class="fas fa-layer-group"></i> Collection</a></li>
                <li><a href="#"><i class="fas fa-cog"></i> Settings</a></li>
            </ul>
        </nav>
        <div class="sidebar-footer">
            <p>Pokémon TCG Manager</p>
            <small>v2.0</small>
        </div>
    </div>

    <main class="main-content">
        <header class="main-header">
            <div class="header-search">
                <form th:action="@{/cards/buscar}" method="post" class="search-form">
                    <div class="search-input-container">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" class="search-input" name="cardId"
                               th:value="${cardId}" placeholder="Search by card ID" required>
                        <button class="search-button" type="submit">Add</button>
                    </div>
                </form>
            </div>
            <div class="header-actions">
                <!-- Botón de carrito mejorado -->
                <button class="cart-button" id="cart-button">
                    <i class="fas fa-shopping-cart"></i>
                    <span class="cart-count">0</span>
                </button>
                <div class="user-profile">
                    <div class="user-avatar">
                        <img src="https://api.dicebear.com/6.x/bottts/svg?seed=trainer" alt="Avatar">
                    </div>
                </div>
            </div>
        </header>

        <div class="content-wrapper">
            <div class="page-title">
                <h1>Store</h1>
                <p>Search for a card to add to your collection</p>
            </div>

            <div class="alert-container" th:if="${error}">
                <div class="alert alert-error">
                    <i class="fas fa-exclamation-circle"></i>
                    <span th:text="${error}"></span>
                    <button class="alert-close"><i class="fas fa-times"></i></button>
                </div>
            </div>

            <!-- Contenedor para notificaciones -->
            <div id="notification-container"></div>

            <div class="cards-container">
                <div class="cards-header">
                    <div class="cards-stats">
                        <div class="stat-item">
                            <span class="stat-value" th:text="${#lists.size(cartas)}">0</span>
                            <span class="stat-label">Cards</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value">$<span
                                    th:text="${#aggregates.sum(cartas.![precio])}">0.00</span></span>
                            <span class="stat-label">Total Value</span>
                        </div>
                    </div>
                    <div class="cards-filters">
                        <div class="filter-dropdown">
                            <button class="filter-button">
                                <i class="fas fa-filter"></i> Filter
                                <i class="fas fa-chevron-down"></i>
                            </button>
                        </div>
                        <div class="view-toggle">
                            <button class="view-button active" data-view="grid">
                                <i class="fas fa-th"></i>
                            </button>
                            <button class="view-button" data-view="list">
                                <i class="fas fa-list"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Grid view (default) -->
                <div class="cards-grid" id="grid-view">
                    <div class="card-item" th:each="carta : ${cartas}">
                        <div class="card-preview">
                            <img th:src="${carta.foto}" alt="Card Image" class="card-image">
                            <div class="card-overlay">
                                <div class="card-actions">
                                    <button class="card-action-button view-btn"><i class="fas fa-eye"></i></button>
                                    <!-- Botón de añadir al carrito -->
                                    <button class="card-action-button cart-btn"
                                            th:data-id="${carta.id}"
                                            th:data-name="${carta.nombre}"
                                            th:data-price="${carta.precio}"
                                            th:data-image="${carta.foto}">
                                        <i class="fas fa-cart-plus"></i>
                                    </button>
                                    <form th:action="@{/cards/eliminar/{id}(id=${carta.id})}" method="post"
                                          class="delete-form">
                                        <button type="submit" class="card-action-button delete-btn"
                                                onclick="return confirm('Are you sure you want to delete this card?')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        <div class="card-info">
                            <h3 class="card-name" th:text="${carta.nombre}">Card Name</h3>
                            <div class="card-meta">
                                <span class="card-type" th:text="${carta.tipo}">Type</span>
                                <span class="card-hp" th:text="${carta.vida + ' HP'}">HP</span>
                            </div>
                            <div class="card-footer">
                                <span class="card-rarity" th:text="${carta.rareza}">Rarity</span>
                                <span class="card-price" th:text="${'$' + #numbers.formatDecimal(carta.precio, 1, 2)}">$0.00</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- List view (alternative) -->
                <div class="cards-list" id="list-view" style="display: none;">
                    <table class="cards-table">
                        <thead>
                        <tr>
                            <th>ID</th>
                            <th>Image</th>
                            <th>Name</th>
                            <th>Type</th>
                            <th>HP</th>
                            <th>Rarity</th>
                            <th>Price</th>
                            <th>Actions</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="carta : ${cartas}">
                            <td th:text="${carta.id}"></td>
                            <td>
                                <div class="table-card-img">
                                    <img th:src="${carta.foto}" alt="Card Image">
                                </div>
                            </td>
                            <td th:text="${carta.nombre}"></td>
                            <td><span class="table-type-badge" th:text="${carta.tipo}"></span></td>
                            <td>
                                <div class="table-hp">
                                    <div class="table-hp-bar">
                                        <div class="table-hp-fill"></div>
                                    </div>
                                    <span th:text="${carta.vida + ' HP'}"></span>
                                </div>
                            </td>
                            <td><span class="table-rarity-badge" th:text="${carta.rareza}"></span></td>
                            <td th:text="${'$' + #numbers.formatDecimal(carta.precio, 1, 2)}"></td>
                            <td>
                                <div class="table-actions">
                                    <button class="table-action-btn view-btn"><i class="fas fa-eye"></i></button>
                                    <!-- Botón de añadir al carrito en vista de lista -->
                                    <button class="table-action-btn cart-btn"
                                            th:data-id="${carta.id}"
                                            th:data-name="${carta.nombre}"
                                            th:data-price="${carta.precio}"
                                            th:data-image="${carta.foto}">
                                        <i class="fas fa-cart-plus"></i>
                                    </button>
                                    <form th:action="@{/cards/eliminar/{id}(id=${carta.id})}" method="post"
                                          class="delete-form">
                                        <button type="submit" class="table-action-btn delete-btn"
                                                onclick="return confirm('Are you sure you want to delete this card?')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Message when there are no cards -->
                <div class="empty-state" th:if="${#lists.isEmpty(cartas)}">
                    <div class="empty-state-icon">
                        <i class="fas fa-search"></i>
                    </div>
                    <h3>There are no cards in your collection</h3>
                    <p>Use the search to add new cards to your collection.</p>
                    <button class="empty-state-button">Browse cards</button>
                </div>
            </div>
        </div>

        <!-- Modal del carrito -->
        <div class="cart-modal" id="cart-modal">
            <div class="cart-modal-content">
                <div class="cart-modal-header">
                    <h3>Shopping Cart</h3>
                    <button class="cart-modal-close"><i class="fas fa-times"></i></button>
                </div>
                <div class="cart-modal-body">
                    <div class="cart-items" id="cart-items">
                        <!-- Los items del carrito se añadirán aquí dinámicamente -->
                    </div>
                    <div class="cart-empty" id="cart-empty">
                        <i class="fas fa-shopping-cart"></i>
                        <p>Your cart is empty</p>
                    </div>
                </div>
                <div class="cart-modal-footer">
                    <div class="cart-total">
                        <span>Total:</span>
                        <span id="cart-total-price">$0.00</span>
                    </div>
                    <button id="checkoutBtn" class="cart-checkout-btn">Checkout</button>
                </div>
            </div>
        </div>

        <!-- Nuevo pop-up de carrito -->
        <div class="cart-popup" id="cart-popup">
            <div class="cart-popup-content">
                <div class="cart-popup-header">
                    <h3>Your Cart</h3>
                    <button class="cart-popup-close"><i class="fas fa-times"></i></button>
                </div>
                <div class="cart-popup-body">
                    <div class="cart-popup-items" id="cart-popup-items">
                        <!-- Los items del carrito se añadirán aquí dinámicamente -->
                    </div>
                    <div class="cart-popup-empty" id="cart-popup-empty">
                        <p>Your cart is empty</p>
                    </div>
                </div>
                <div class="cart-popup-footer">
                    <div class="cart-popup-total">
                        <span>Total:</span>
                        <span id="cart-popup-total-price">$0.00</span>
                    </div>
                    <a href="compra.html" class="cart-popup-buy-btn">Buy Now</a>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- Script para la funcionalidad del carrito y vistas -->
<script> document.addEventListener('DOMContentLoaded', function () {
    const cartButton = document.querySelector('.cart-button');
    const cartModal = document.getElementById('cart-modal');
    const cartModalClose = document.querySelector('.cart-modal-close');
    const cartItems = document.getElementById('cart-items');
    const cartEmpty = document.getElementById('cart-empty');
    const cartTotalPrice = document.getElementById('cart-total-price');
    const cartCount = document.querySelector('.cart-count');
    const notificationContainer = document.getElementById('notification-container'); // Carrito de compras
    let cart = [];

    function updateCartCount() {
        const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
        cartCount.textContent = totalItems;
        if (totalItems > 0) {
            cartCount.classList.add('has-items');
        } else {
            cartCount.classList.remove('has-items');
        }
    }

    function updateCartTotal() {
        const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        cartTotalPrice.textContent = `$${total.toFixed(2)}`;
    }

    function renderCartItems() {
        if (cart.length === 0) {
            cartItems.style.display = 'none';
            cartEmpty.style.display = 'flex';
        } else {
            cartItems.style.display = 'block';
            cartEmpty.style.display = 'none';
            cartItems.innerHTML = '';
            cart.forEach((item, index) => {
                const cartItem = document.createElement('div');
                cartItem.className = 'cart-item';
                cartItem.innerHTML = ` <div class="cart-item-image"> <img src="${item.image}" alt="${item.name}"> </div> <div class="cart-item-details"> <h4>${item.name}</h4> <div class="cart-item-price">$${item.price.toFixed(2)}</div> </div> <div class="cart-item-quantity"> <button class="quantity-btn minus" data-index="${index}">-</button> <span>${item.quantity}</span> <button class="quantity-btn plus" data-index="${index}">+</button> </div> <button class="cart-item-remove" data-index="${index}"> <i class="fas fa-trash"></i> </button> `;
                cartItems.appendChild(cartItem);
            });
            document.querySelectorAll('.quantity-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    const index = parseInt(this.getAttribute('data-index'));
                    if (this.classList.contains('minus')) {
                        if (cart[index].quantity > 1) {
                            cart[index].quantity--;
                        } else {
                            cart.splice(index, 1);
                        }
                    } else if (this.classList.contains('plus')) {
                        cart[index].quantity++;
                    }
                    updateCartCount();
                    updateCartTotal();
                    renderCartItems();
                    localStorage.setItem('pokemonCart', JSON.stringify(cart));
                });
            });
            document.querySelectorAll('.cart-item-remove').forEach(btn => {
                btn.addEventListener('click', function () {
                    const index = parseInt(this.getAttribute('data-index'));
                    cart.splice(index, 1);
                    updateCartCount();
                    updateCartTotal();
                    renderCartItems();
                    localStorage.setItem('pokemonCart', JSON.stringify(cart));
                });
            });
        }
    }

    document.getElementById("checkoutBtn").addEventListener("click", function () {
        const usuario = "usuario123"; // Puedes obtenerlo dinámicamente si tienes login
        const productos = carrito.map(p => p.nombre); // Ajusta según tu estructura de carrito
        const total = carrito.reduce((acc, p) => acc + p.precio, 0);

        fetch("/api/pedidos/crear", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                usuario: usuario,
                productos: productos,
                total: total
            })
        })
        .then(res => res.json())
        .then(data => {
            console.log("Pedido guardado:", data);
            alert("¡Pedido realizado con éxito!");
            // Puedes vaciar el carrito aquí
        })
        .catch(err => console.error("Error al guardar el pedido:", err));
    });

    cartButton.addEventListener('click', (e) => {
        e.stopPropagation();
        cartModal.classList.add('open');
        renderCartItems();
    });
    cartModalClose.addEventListener('click', () => {
        cartModal.classList.remove('open');
    });
    window.addEventListener('click', (e) => {
        if (e.target === cartModal) {
            cartModal.classList.remove('open');
        }
    });
    document.querySelector('.cart-checkout-btn').addEventListener('click', function () {
        window.location.href = 'compra.html';
    });
    document.querySelectorAll('.cart-btn').forEach(btn => {
        btn.addEventListener('click', function (e) {
            e.stopPropagation();
            const id = this.getAttribute('data-id');
            const name = this.getAttribute('data-name');
            const price = parseFloat(this.getAttribute('data-price'));
            const image = this.getAttribute('data-image');
            const existingItemIndex = cart.findIndex(item => item.id === id);
            if (existingItemIndex !== -1) {
                cart[existingItemIndex].quantity++;
                showNotification(`Added another ${name} to your cart!`);
            } else {
                cart.push({id, name, price, image, quantity: 1});
                showNotification(`${name} added to your cart!`);
            }
            localStorage.setItem('pokemonCart', JSON.stringify(cart));
            updateCartCount();
            updateCartTotal();
            const rect = this.getBoundingClientRect();
            animateAddToCart(image, rect.left, rect.top);
        });
    });

    function showNotification(message, type = 'success') {
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.innerHTML = ` <div class="notification-icon"> <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i> </div> <div class="notification-content"> <p>${message}</p> </div> <button class="notification-close"> <i class="fas fa-times"></i> </button> `;
        notificationContainer.appendChild(notification);
        setTimeout(() => {
            notification.classList.add('show');
        }, 10);
        setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => {
                notification.remove();
            }, 300);
        }, 3000);
        notification.querySelector('.notification-close').addEventListener('click', () => {
            notification.classList.remove('show');
            setTimeout(() => {
                notification.remove();
            }, 300);
        });
    }

    function animateAddToCart(imageUrl, startX, startY) {
        const flyingImage = document.createElement('div');
        flyingImage.className = 'flying-image';
        flyingImage.style.backgroundImage = `url(${imageUrl})`;
        document.body.appendChild(flyingImage);
        flyingImage.style.left = `${startX}px`;
        flyingImage.style.top = `${startY}px`;
        const cartButtonRect = cartButton.getBoundingClientRect();
        const targetX = cartButtonRect.left + (cartButtonRect.width / 2);
        const targetY = cartButtonRect.top + (cartButtonRect.height / 2);
        setTimeout(() => {
            flyingImage.style.transform = 'scale(0.3)';
            flyingImage.style.left = `${targetX}px`;
            flyingImage.style.top = `${targetY}px`;
            flyingImage.style.opacity = '0';
            setTimeout(() => {
                flyingImage.remove();
                cartButton.classList.add('bounce');
                setTimeout(() => {
                    cartButton.classList.remove('bounce');
                }, 300);
            }, 800);
        }, 10);
    }

    const savedCart = localStorage.getItem('pokemonCart');
    if (savedCart) {
        cart = JSON.parse(savedCart);
        updateCartCount();
        updateCartTotal();
    }
    const gridViewBtn = document.querySelector('[data-view="grid"]');
    const listViewBtn = document.querySelector('[data-view="list"]');
    const gridView = document.getElementById('grid-view');
    const listView = document.getElementById('list-view');
    gridViewBtn.addEventListener('click', function () {
        gridView.style.display = 'grid';
        listView.style.display = 'none';
        gridViewBtn.classList.add('active');
        listViewBtn.classList.remove('active');
    });
    listViewBtn.addEventListener('click', function () {
        gridView.style.display = 'none';
        listView.style.display = 'block';
        listViewBtn.classList.add('active');
        gridViewBtn.classList.remove('active');
    });
    const alertCloseBtn = document.querySelector('.alert-close');
    if (alertCloseBtn) {
        alertCloseBtn.addEventListener('click', function () {
            document.querySelector('.alert').style.display = 'none';
        });
    }
});
</script>
</body>
</html>